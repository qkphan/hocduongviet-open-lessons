name: Exam Pipeline (End-to-End)

on:
  workflow_dispatch:
    inputs:
      raw_exam_path:
        description: "Path to raw_exam.json"
        required: true

      enable_ai_revise:
        description: "Enable AI revise"
        required: false
        default: "false"


jobs:
  exam-pipeline:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install jsonschema

      # ===============================
      # STEP 0 – INGEST RAW EXAM
      # ===============================
      - name: Ingest raw exam
        id: ingest
        run: |
          uid=$(python tools/engine/exams/step1_preparation/ingest_raw_exam.py \
            "${{ inputs.raw_exam_path }}" ui)
          echo "raw_exam_uid=$uid" >> $GITHUB_OUTPUT
          echo "Raw exam UID: $uid"

      # ===============================
      # STEP 1 – VALIDATE
      # ===============================
      - name: Validate exam
        id: validate
        run: |
          python tools/engine/exams/step2_validation/exam_validate.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # OPTIONAL AI REVISE
      # ===============================
      - name: AI Revise
        if: inputs.enable_ai_revise == 'true'
        run: |
          python tools/engine/exams/step2_validation/exam_revise.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      - name: Re-Validate
        if: inputs.enable_ai_revise == 'true'
        run: |
          python tools/engine/exams/step2_validation/exam_validate.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # STEP 3 – SAVE DB
      # ===============================
      - name: Save to school.db
        run: |
          python tools/engine/exams/step3_save_to_database/save_to_school_db.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"


      # ===============================
      # STEP 4 – LaTeX
      # ===============================
      - name: Export LaTeX
        if: contains(steps.validate.outputs.result, 'PASS')
        run: |
          python tools/engine/exams/step4_publish_latex/exam_to_latex.py \
            "${{ inputs.raw_exam_uid }}"

    # ===============================
    # 8. Upload Artifact
    # ===============================
      - name: Upload Exam PDF
        uses: actions/upload-artifact@v4
        with:
          name: exam-pdf
          path: exam.pdf

