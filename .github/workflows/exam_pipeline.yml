name: Exam Pipeline (End-to-End)

on:
  workflow_dispatch:
    inputs:
      raw_exam_path:
        description: "Path to raw_exam.json"
        required: true

      enable_ai_revise:
        description: "Enable AI revise when validation fails"
        required: false
        default: "false"

jobs:
  exam-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install jsonschema

      # ===============================
      # STEP 0 – INGEST RAW EXAM
      # ===============================
      - name: Ingest raw exam
        id: ingest
        run: |
          uid=$(python tools/engine/exams/step1_preparation/ingest_raw_exam.py \
            "${{ inputs.raw_exam_path }}" ui)
          echo "raw_exam_uid=$uid" >> $GITHUB_OUTPUT
          echo "Raw exam UID: $uid"

      - name: Verify raw exam exists
        run: |
          sqlite3 data/raw_database.db \
            "SELECT raw_exam_uid FROM raw_exams WHERE raw_exam_uid='${{ steps.ingest.outputs.raw_exam_uid }}';"

      # ===============================
      # STEP 1 – VALIDATE (FIRST PASS)
      # ===============================
      - name: Validate exam (initial)
        id: validate_initial
        run: |
          python tools/engine/exams/step2_validation/exam_validate.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # OPTIONAL AI REVISE
      # ===============================
      - name: AI Revise
        id: ai_revise
        if: |
          inputs.enable_ai_revise == 'true' &&
          steps.validate_initial.outputs.result == 'FAILED'
        run: |
          python tools/engine/exams/step2_validation/exam_revise.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # STEP 2 – RE-VALIDATE (AFTER AI)
      # ===============================
      - name: Validate exam (after AI revise)
        id: validate_after_ai
        if: |
          inputs.enable_ai_revise == 'true' &&
          steps.validate_initial.outputs.result == 'FAILED'
        run: |
          python tools/engine/exams/step2_validation/exam_validate.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # STEP 3 – SAVE TO SCHOOL.DB
      # ===============================
      - name: Save to school.db
        if: |
          steps.validate_initial.outputs.result == 'PASSED' ||
          steps.validate_after_ai.outputs.result == 'PASSED'
        run: |
          python tools/engine/exams/step3_save_to_database/save_to_school_db.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # STEP 4 – EXPORT LATEX
      # ===============================
      - name: Export LaTeX
        if: |
          steps.validate_initial.outputs.result == 'PASSED' ||
          steps.validate_after_ai.outputs.result == 'PASSED'
        run: |
          python tools/engine/exams/step4_publish_latex/exam_to_latex.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # STEP 5 – BUILD PDF
      # ===============================
      - name: Build PDF
        if: |
          steps.validate_initial.outputs.result == 'PASSED' ||
          steps.validate_after_ai.outputs.result == 'PASSED'
        run: |
          python tools/engine/exams/step5_publish_pdf/latex_to_pdf.py \
            "${{ steps.ingest.outputs.raw_exam_uid }}"

      # ===============================
      # UPLOAD ARTIFACTS
      # ===============================
      - name: Upload raw database
        uses: actions/upload-artifact@v4
        with:
          name: raw-database
          path: data/raw_database.db

      - name: Upload Exam PDF
        if: |
          steps.validate_initial.outputs.result == 'PASSED' ||
          steps.validate_after_ai.outputs.result == 'PASSED'
        uses: actions/upload-artifact@v4
        with:
          name: exam-pdf
          path: exams/**/export/*.pdf

