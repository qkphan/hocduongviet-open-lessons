name: Build Exams (AI + Data + LaTeX)

on:
  workflow_dispatch:
    inputs:
      enable_ai:
        description: "Enable Gemini AI (true/false)"
        required: true
        default: "false"

jobs:
  build-exam:
    runs-on: ubuntu-latest

    steps:
    # ===============================
    # 1. Checkout
    # ===============================
    - name: Checkout repository
      uses: actions/checkout@v4

    # ===============================
    # 2. Setup Python
    # ===============================
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema google-genai

    # ===============================
    # 3. AI Generate exam.ai.json
    # ===============================
    - name: Generate exam (AI ‚Üí exam.ai.json)
      if: ${{ inputs.enable_ai == 'true' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python tools/engine/exams/ai_generate.py \
          --output data/exams/exam.ai.json

    # ===============================
    # 4. Validate (NO auto-fix when AI disabled)
    # ===============================
    - name: Validate exam JSON
      run: |
        python tools/engine/exams/exam_validate.py exams

    # ===============================
    # 4b. Optional AI Auto-fix
    # ===============================
    - name: AI Fix exam JSON
      if: ${{ inputs.enable_ai == 'true' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        MAX_RETRY=3
        COUNT=0

        until python tools/engine/exams/exam_validate.py exams; do
          COUNT=$((COUNT+1))
          if [ "$COUNT" -ge "$MAX_RETRY" ]; then
            echo "‚ùå Exam JSON still invalid after $MAX_RETRY attempts"
            exit 1
          fi
          echo "üîÅ Fixing JSON (attempt $COUNT)..."
          python tools/engine/exams/ai_fix.py exams
        done

    # ===============================
    # 5. Generate exam_data.tex
    # ===============================
    - name: Generate exam_data.tex
      run: |
        python tools/engine/exams/examengine.py \
          --input exams \
          --output exams/build/exam_data.tex

    # ===============================
    # 6. Install LaTeX
    # ===============================
    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          latexmk

    # ===============================
    # 7. Compile Exam PDF
    # ===============================
    - name: Compile exam PDF
      run: |
        latexmk -pdf \
          -jobname=exam \
          styles/layouts/exams/exam_layout.tex

    # ===============================
    # 8. Upload Artifact
    # ===============================
    - name: Upload Exam PDF
      uses: actions/upload-artifact@v4
      with:
        name: exam-pdf
        path: exam.pdf
