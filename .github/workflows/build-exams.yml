name: Build Exams (AI + Schema + LaTeX)

# on:
#   push:
#     paths:
#       - "engine/**"
#       - "tools/**"
#       - "styles/**"
#       - ".github/workflows/build-exam.yml"
#   workflow_dispatch:

on:
  workflow_dispatch:
    inputs:
      enable_ai:
        description: "Enable Gemini AI"
        required: true
        default: "true"

jobs:
  build-exam:
    runs-on: ubuntu-latest

    steps:
    # ===============================
    # 1. Checkout
    # ===============================
    - name: Checkout repository
      uses: actions/checkout@v4

    # ===============================
    # 2. Setup Python
    # ===============================
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Python dependencies
      run: |
        # pip install jsonschema openai
        python -m pip install --upgrade pip
        pip install jsonschema google-genai
  
    # ===============================
    # 3. AI Generate exam.json
    # ===============================
    - name: Generate exam JSON (AI)
      env:
        # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python engine/exams/ai_generate.py

    # ===============================
    # 4. Validate & Auto-fix loop
    # ===============================
    - name: Validate & Fix exam JSON
      env:
        # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        MAX_RETRY=3
        COUNT=0

        until python engine/exams/exam_validate.py; do
          COUNT=$((COUNT+1))
          if [ "$COUNT" -ge "$MAX_RETRY" ]; then
            echo "‚ùå JSON still invalid after $MAX_RETRY attempts"
            exit 1
          fi
          echo "üîÅ Fixing JSON (attempt $COUNT)..."
          python engine/exams/ai_fix.py
        done

    # ===============================
    # 5. Generate exam_data.tex
    # ===============================
    - name: Generate exam_data.tex
      run: |
        python engine/exams/examengine.py

    # ===============================
    # 6. Install LaTeX
    # ===============================
    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          latexmk

    # ===============================
    # 7. Compile Exam PDF
    # ===============================
    - name: Compile exam PDF
      run: |
        latexmk -pdf \
          -jobname=exam \
          styles/layouts/exams/exam_layout.tex

    # ===============================
    # 8. Upload Artifact
    # ===============================
    - name: Upload Exam PDF
      uses: actions/upload-artifact@v4
      with:
        name: exam-pdf
        path: exam.pdf
